<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <title>E-Album Creator</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script> tailwind.config = { darkMode: 'class' } </script>

  <!-- Material Icons & Inter font -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <!-- React & Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Flipbook -->
  <link href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/css/page-flip.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>

  <!-- QR Code -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)}}
    .fade-in{ animation: fadeIn .35s ease-out }
    .nav-glass { backdrop-filter: blur(10px); background: rgba(255,255,255,.75); }
    .dark .nav-glass { background: rgba(2,6,23,.6); }

    /* Flipbook sizing */
    .flipbook-wrap { position: relative; width: 100%; display:flex; justify-content:center; }
    .flipbook-container { width: 90vw; height: 70vh; max-width: 1200px; max-height: 680px; } /* desktop */
    .flip-page { background:#f8fafc; box-shadow:0 0 20px rgba(0,0,0,.2); display:flex; align-items:center; justify-content:center; }
    .flip-page img{ max-width:100%; max-height:100%; object-fit:contain }
    .cover-page{ background:#1e293b; color:#fff; display:flex; align-items:center; justify-content:center; text-align:center; padding:2rem }
    .dark .flip-page{ background:#1e293b }
    .dark .cover-page{ background:#0f172a }
    .dragging{ opacity:.5; transform: scale(.97) }
    .floating-btn { box-shadow: 0 10px 30px rgba(99,102,241,.3); }

    /* ⬅️ UPDATED: Mobile polish */
    @media (max-width: 767px) {
      .flipbook-container { width: 98vw; height: 68vh; max-height: 68vh; }
      .mobile-pad { padding-left: .75rem; padding-right: .75rem; }
      .mobile-card { border-radius: 1rem; }
      .mobile-btn { height: 48px; border-radius: 12px; }
      .grid-tight { gap: .75rem; }
    }

    /* ⬅️ NEW: Landscape prompt overlay on phones */
    .rotate-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.6);
      display: flex; align-items:center; justify-content:center;
      z-index: 60;
    }
    .rotate-box {
      width: min(92vw, 480px);
      background: white;
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0,0,0,.35);
    }
    .dark .rotate-box { background: #0b1220; }
  </style>
</head>

<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 transition-colors duration-300">
  <div id="root"></div>

  <!-- Firebase SDK (module) -->
  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyC96IBERvo9hPIYnb8e_rE7ZDQWo-82-Ro",
      authDomain: "vcl-e-albums.firebaseapp.com",
      projectId: "vcl-e-albums",
      storageBucket: "vcl-e-albums.firebasestorage.app",
      messagingSenderId: "672794004963",
      appId: "1:672794004963:web:c028608bab7f0c498324d6"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signOut,
      GoogleAuthProvider, signInWithPopup,
      createUserWithEmailAndPassword, signInWithEmailAndPassword,
      sendEmailVerification, sendPasswordResetEmail,
      EmailAuthProvider, reauthenticateWithCredential, updatePassword
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, collection, addDoc, query, where,
      getDocs, deleteDoc, updateDoc, increment, Timestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    window.firebaseServices = {
      auth: getAuth(app),
      db: getFirestore(app),
      GoogleAuthProvider,
      onAuthStateChanged, signOut, signInWithPopup,
      createUserWithEmailAndPassword, signInWithEmailAndPassword,
      sendEmailVerification, sendPasswordResetEmail,
      EmailAuthProvider, reauthenticateWithCredential, updatePassword,
      doc, getDoc, setDoc, collection, addDoc, query, where,
      getDocs, deleteDoc, updateDoc, increment, Timestamp
    };
  </script>

  <!-- App -->
  <script type="text/babel">
    const {useState, useEffect, useRef} = React;

    const {
      auth, db, GoogleAuthProvider, onAuthStateChanged, signOut,
      signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword,
      sendEmailVerification, sendPasswordResetEmail,
      EmailAuthProvider, reauthenticateWithCredential, updatePassword,
      doc, getDoc, setDoc, collection, addDoc, query, where,
      getDocs, deleteDoc, updateDoc, increment, Timestamp
    } = window.firebaseServices;

    /* ------------------ Payment / Plans Config ------------------ */
    const CLOUD_NAME = "dpw09bhnh";
    const UPLOAD_PRESET = "ml_default";

    const PAYTM = {
      MID: "YOUR_MID_HERE",
      ENV: "STAGE",
      CREATE_ORDER_API: "/api/createPaytmOrder",
      USE_DEV_FAKE_PAYMENTS: true
    };

    const PLANS = {
      free:     { name:'Free',     limit:2,   priceRs:0,   features:{ qrDownload:false, customMusic:false, editSheets:false, support:false, passwordProtection:false, socialLinks:false, showLabName:false } },
      basic:    { name:'Basic',    limit:40,  priceRs:299, features:{ qrDownload:true,  customMusic:false, editSheets:false, support:false, passwordProtection:false, socialLinks:false, showLabName:true  } },
      standard: { name:'Standard', limit:100, priceRs:599, features:{ qrDownload:true,  customMusic:true,  editSheets:true,  support:true,  passwordProtection:false, socialLinks:false, showLabName:true  } },
      premium:  { name:'Premium',  limit:250, priceRs:999, features:{ qrDownload:true,  customMusic:true,  editSheets:true,  support:true,  passwordProtection:true,  socialLinks:true,  showLabName:true  } },
    };

    const PRELOADED_MUSIC = [
      { name:'Inspiring Cinematic Ambient', url:'https://res.cloudinary.com/dpw09bhnh/video/upload/v1693064531/bensound-inspiring-cinematic-ambient_f6b2e1.mp3' },
      { name:'Romantic Sentimental Piano', url:'https://res.cloudinary.com/dpw09bhnh/video/upload/v1693064531/bensound-romantic-sentimental-piano_em8jdf.mp3' },
      { name:'Happy Upbeat Acoustic',      url:'https://res.cloudinary.com/dpw09bhnh/video/upload/v1693064531/bensound-happy-upbeat-acoustic_q7b1z2.mp3' },
    ];

    const MaterialIcon = ({name, className=""}) => <span className={`material-icons ${className}`}>{name}</span>;
    const rupee = (n)=> `₹${Number(n).toLocaleString('en-IN')}`;

    const Loader = ({text='Loading...', progress=null}) => (
      <div className="fixed inset-0 bg-white/80 dark:bg-slate-900/80 flex flex-col items-center justify-center z-50">
        {progress!==null ? (
          <div className="relative w-20 h-20">
            <svg className="w-full h-full" viewBox="0 0 100 100">
              <circle className="text-slate-200 dark:text-slate-700" strokeWidth="10" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50"/>
              <circle className="text-indigo-600" strokeWidth="10" strokeDasharray="283" strokeDashoffset={`calc(283 - (283 * ${progress}) / 100)`} strokeLinecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50"/>
            </svg>
            <span className="absolute inset-0 flex items-center justify-center text-xl font-semibold">{progress}%</span>
          </div>
        ) : (
          <div className="w-16 h-16 border-8 border-slate-200 dark:border-slate-700 border-t-indigo-600 rounded-full animate-spin"/>
        )}
        <p className="mt-4 text-slate-600 dark:text-slate-400">{text}</p>
      </div>
    );

    const ThemeToggle = ({theme, onToggle}) => (
      <button onClick={onToggle} className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition" title="Toggle theme">
        <MaterialIcon name={theme==='dark' ? 'light_mode' : 'dark_mode'} />
      </button>
    );

    /* ------------------ Top Navigation ------------------ */
    const TopNav = ({view, setView, user, theme, toggleTheme}) => {
      const [menuOpen, setMenuOpen] = useState(false);
      useEffect(() => {
        const onClick = (e) => { if (!e.target.closest('#profileMenu')) setMenuOpen(false); };
        window.addEventListener('click', onClick);
        return () => window.removeEventListener('click', onClick);
      }, []);

      const NavBtn = ({id, label, icon}) => (
        <button
          onClick={()=>setView(id)}
          className={`px-3 py-2 rounded-lg flex items-center gap-2 transition ${view===id ? 'bg-indigo-600 text-white' : 'hover:bg-slate-100 dark:hover:bg-slate-800'}`}
        >
          <MaterialIcon name={icon} />
          <span className="hidden sm:block">{label}</span>
        </button>
      );

      return (
        <header className="sticky top-0 z-40 nav-glass border-b border-slate-200/60 dark:border-slate-700/60">
          <div className="max-w-7xl mx-auto px-3 sm:px-4">
            <div className="h-16 flex items-center justify-between">
              <div className="flex items-center gap-2">
                <div className="w-9 h-9 rounded-xl bg-indigo-600 text-white grid place-items-center animate-pulse">
                  <MaterialIcon name="photo_album"/>
                </div>
                <div className="text-xl font-bold">E-Album</div>
              </div>

              <nav className="hidden md:flex items-center gap-2">
                <NavBtn id="dashboard" label="Dashboard" icon="dashboard"/>
                <NavBtn id="uploader"  label="Create Album" icon="add_photo_alternate"/>
                <NavBtn id="pricing"   label="Pricing" icon="sell"/>
                <NavBtn id="faq"       label="FAQ" icon="help_center"/>
                <NavBtn id="contact"   label="Contact" icon="call"/>
              </nav>

              <div className="flex items-center gap-1 sm:gap-2" id="profileMenu">
                <ThemeToggle theme={theme} onToggle={toggleTheme}/>
                <button
                  onClick={()=>setMenuOpen(v=>!v)}
                  className="flex items-center gap-2 px-2 sm:px-3 py-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition"
                  title={user?.email}
                >
                  <div className="w-9 h-9 rounded-full bg-gradient-to-tr from-indigo-600 to-fuchsia-500 text-white grid place-items-center">
                    <MaterialIcon name="person"/>
                  </div>
                  <MaterialIcon name="expand_more" className="hidden sm:block" />
                </button>

                {menuOpen && (
                  <div className="absolute right-2 sm:right-4 top-14 w-56 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-200 dark:border-slate-700 fade-in">
                    <div className="px-4 py-3 border-b dark:border-slate-700">
                      <p className="text-sm font-medium truncate">{user?.displayName || user?.email}</p>
                    </div>
                    <button onClick={()=>window.__setView && window.__setView('profile')} className="w-full px-4 py-3 text-left hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center gap-2">
                      <MaterialIcon name="settings"/> Profile
                    </button>
                    <button onClick={()=>signOut(auth)} className="w-full px-4 py-3 text-left hover:bg-slate-100 dark:hover:bg-slate-700 text-red-600 flex items-center gap-2">
                      <MaterialIcon name="logout"/> Logout
                    </button>
                  </div>
                )}
              </div>
            </div>

            {/* Mobile quick nav */}
            <div className="md:hidden pb-3 grid grid-cols-5 gap-2">
              <button onClick={()=>window.__setView('dashboard')} className={`mobile-btn text-sm ${view==='dashboard'?'bg-indigo-600 text-white':'bg-slate-100 dark:bg-slate-800'}`}>Home</button>
              <button onClick={()=>window.__setView('uploader')}  className={`mobile-btn text-sm ${view==='uploader' ?'bg-indigo-600 text-white':'bg-slate-100 dark:bg-slate-800'}`}>Create</button>
              <button onClick={()=>window.__setView('pricing')}   className={`mobile-btn text-sm ${view==='pricing'  ?'bg-indigo-600 text-white':'bg-slate-100 dark:bg-slate-800'}`}>Plans</button>
              <button onClick={()=>window.__setView('faq')}       className={`mobile-btn text-sm ${view==='faq'      ?'bg-indigo-600 text-white':'bg-slate-100 dark:bg-slate-800'}`}>FAQ</button>
              <button onClick={()=>window.__setView('contact')}   className={`mobile-btn text-sm ${view==='contact'  ?'bg-indigo-600 text-white':'bg-slate-100 dark:bg-slate-800'}`}>Contact</button>
            </div>
          </div>
        </header>
      );
    };

    /* ------------------ Auth, NewUser, Profile screens (unchanged layout; add mobile paddings) ------------------ */
    const AuthScreen = () => {
      const [isLogin, setIsLogin] = useState(true);
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      const [resetMsg, setResetMsg] = useState('');

      const friendly = (code) => ({
        'auth/invalid-email':'Please enter a valid email.',
        'auth/user-not-found':'Invalid email or password.',
        'auth/wrong-password':'Invalid email or password.',
        'auth/email-already-in-use':'An account with this email already exists.',
        'auth/weak-password':'Password should be at least 6 characters long.',
        'auth/popup-closed-by-user':'Sign-in window closed.'
      }[code] || 'An unknown error occurred.');

      const handleAuth = async () => {
        if (!email || !password) return setError('Please enter both email and password.');
        setLoading(true); setError(''); setResetMsg('');
        try {
          if (isLogin) await signInWithEmailAndPassword(auth, email, password);
          else {
            const cred = await createUserWithEmailAndPassword(auth, email, password);
            await sendEmailVerification(cred.user);
          }
        } catch (e) { setError(friendly(e.code)); }
        finally { setLoading(false); }
      };

      const handleGoogle = async () => {
        setLoading(true); setError(''); setResetMsg('');
        try { await signInWithPopup(auth, new GoogleAuthProvider()); }
        catch (e) { setError(friendly(e.code)); }
        finally { setLoading(false); }
      };

      const handleForgot = async () => {
        if (!email) return setResetMsg('Enter your email above and tap "Forgot password" again.');
        setLoading(true); setError(''); setResetMsg('');
        try { await sendPasswordResetEmail(auth, email); setResetMsg('Password reset link sent! Check your inbox.'); }
        catch (e) { setError(friendly(e.code)); }
        finally { setLoading(false); }
      };

      return (
        <div className="min-h-screen grid place-items-center p-3 sm:p-4">
          {loading && <Loader text={isLogin?'Signing in…':'Signing up…'} />}

          <div className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-md fade-in mobile-card">
            <div className="text-center">
              <h1 className="text-2xl sm:text-3xl font-bold">{isLogin?'Welcome Back':'Create Account'}</h1>
              <p className="mt-1 text-slate-500 text-sm sm:text-base">Sign in to create your albums.</p>
            </div>
            <div className="mt-6 space-y-4">
              <input type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="Email" className="w-full px-4 py-3 border rounded-lg bg-transparent border-slate-300 dark:border-slate-600"/>
              <input type="password" value={password} onChange={e=>setPassword(e.target.value)} placeholder="Password" className="w-full px-4 py-3 border rounded-lg bg-transparent border-slate-300 dark:border-slate-600"/>
              {error && <p className="text-red-500 text-sm">{error}</p>}
              {resetMsg && <p className="text-emerald-500 text-sm">{resetMsg}</p>}
              <button onClick={handleAuth} className="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold active:scale-[.99] transition mobile-btn">{isLogin?'Sign In':'Sign Up'}</button>
              <div className="flex items-center justify-between text-sm">
                <button onClick={()=>setIsLogin(v=>!v)} className="font-semibold text-indigo-600 dark:text-indigo-400">{isLogin?'Create an account':'Have an account? Sign In'}</button>
                <button onClick={handleForgot} className="text-slate-600 hover:text-indigo-600">Forgot password?</button>
              </div>
              <div className="my-3 flex items-center gap-3">
                <div className="flex-1 border-t dark:border-slate-700"></div>
                <span className="text-slate-500 text-sm">OR</span>
                <div className="flex-1 border-t dark:border-slate-700"></div>
              </div>
              <button onClick={handleGoogle} className="w-full bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-100 border border-slate-300 dark:border-slate-600 py-3 rounded-lg font-semibold flex items-center justify-center gap-2 mobile-btn">
                <MaterialIcon name="login"/> Sign in with Google
              </button>
            </div>
          </div>
        </div>
      );
    };

    const VerifyEmailScreen = ({user}) => (
      <div className="min-h-screen grid place-items-center p-3 sm:p-4">
        <div className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-md text-center fade-in mobile-card">
          <MaterialIcon name="mark_email_read" className="text-6xl text-emerald-500"/>
          <h1 className="text-2xl font-bold mt-4">Verify Your Email</h1>
          <p className="mt-2">We sent a verification link to <strong>{user.email}</strong>.</p>
          <p className="text-sm text-slate-500 mt-2">(Refresh this page after verifying.)</p>
        </div>
      </div>
    );

    const NewUserDetailsForm = ({user, onComplete}) => {
      const [step, setStep] = useState(1);
      const [anim, setAnim] = useState('fade-in');
      const [details, setDetails] = useState({ name:user.displayName || '', labName:'', city:'', age:'', gender:'' });
      const next = () => { setAnim(''); setTimeout(()=>{ setStep(s=>s+1); setAnim('fade-in'); }, 60); };
      const save = async () => { if (!details.gender) return alert('Please select a gender.'); await onComplete(details); };
      const Box = ({children}) => <div className={`bg-white dark:bg-slate-800 p-6 sm:p-8 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 w-full max-w-lg ${anim} mobile-card`}>{children}</div>;
      return (
        <div className="min-h-screen grid place-items-center p-3 sm:p-4">
          <Box>
            {step===1 && (<div><h2 className="text-2xl font-bold text-center mb-4">What's your name?</h2><input value={details.name} onChange={e=>setDetails({...details, name:e.target.value})} placeholder="e.g., John Doe" className="w-full px-4 py-3 border rounded-lg bg-transparent"/><button onClick={next} className="mt-6 w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold mobile-btn">Next</button></div>)}
            {step===2 && (<div><h2 className="text-2xl font-bold text-center mb-4">Your studio/lab name?</h2><input value={details.labName} onChange={e=>setDetails({...details, labName:e.target.value})} placeholder="e.g., John's Photography" className="w-full px-4 py-3 border rounded-lg bg-transparent"/><button onClick={next} className="mt-6 w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold mobile-btn">Next</button></div>)}
            {step===3 && (<div><h2 className="text-2xl font-bold text-center mb-4">Where are you based?</h2><input value={details.city} onChange={e=>setDetails({...details, city:e.target.value})} placeholder="City" className="w-full px-4 py-3 border rounded-lg bg-transparent"/><button onClick={next} className="mt-6 w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold mobile-btn">Next</button></div>)}
            {step===4 && (<div><h2 className="text-2xl font-bold text-center mb-4">How old are you?</h2><input type="number" value={details.age} onChange={e=>setDetails({...details, age:e.target.value})} placeholder="e.g., 25" className="w-full px-4 py-3 border rounded-lg bg-transparent"/><button onClick={next} className="mt-6 w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold mobile-btn">Next</button></div>)}
            {step===5 && (<div><h2 className="text-2xl font-bold text-center mb-4">What's your gender?</h2><div className="flex justify-center gap-3 sm:gap-4">{['male','female','other'].map(g => (<div key={g} onClick={()=>setDetails({...details, gender:g})} className={`flex flex-col items-center p-4 border-2 rounded-lg w-24 sm:w-28 cursor-pointer transition ${details.gender===g?'bg-indigo-600 text-white border-indigo-600':'hover:bg-slate-50 dark:hover:bg-slate-700'}`}><MaterialIcon name={g === 'other' ? 'person' : g} className="text-4xl"/><span className="mt-2 font-medium capitalize">{g==='other'?'Other':g}</span></div>))}</div><button onClick={save} className="mt-6 w-full bg-emerald-600 text-white py-3 rounded-lg font-semibold mobile-btn">Save & Continue</button></div>)}
          </Box>
        </div>
      );
    };

    /* ------------------ Utilities ------------------ */
    const addMonths = (date, months)=> { const d = new Date(date); d.setMonth(d.getMonth()+months); return d; };
    const effectivePlanKey = (userData) => {
      const now = new Date();
      const key = userData?.plan || 'free';
      if (key === 'free') return 'free';
      const exp = userData?.planExpiry?.toDate ? userData.planExpiry.toDate() : (userData?.planExpiry ? new Date(userData.planExpiry) : null);
      if (!exp || exp < now) return 'free';
      return key;
    };
    async function getThisMonthAlbumCount(uid){
      const now = new Date();
      const start = new Date(now.getFullYear(), now.getMonth(), 1);
      const qy = query(collection(db, 'albums'), where('uid', '==', uid), where('createdAt', '>=', Timestamp.fromDate(start)));
      const snap = await getDocs(qy);
      return snap.size;
    }

    function loadPaytmScript(mid, env='PROD'){
      return new Promise((resolve, reject)=>{
        if (window.Paytm && window.Paytm.CheckoutJS) return resolve();
        const script = document.createElement('script');
        const host = env==='PROD' ? 'https://securegw.paytm.in' : 'https://securegw-stage.paytm.in';
        script.src = `${host}/merchantpgpui/checkoutjs/merchants/${mid}.js`;
        script.onload = ()=> resolve();
        script.onerror = ()=> reject(new Error('Failed to load Paytm CheckoutJS'));
        document.body.appendChild(script);
      });
    }
    async function startPaytmCheckout({ mid, env, orderId, amount, txnToken, onSuccess, onFailure }){
      await loadPaytmScript(mid, env);
      const config = {
        root: "",
        flow: "DEFAULT",
        data: { orderId, token: txnToken, tokenType: "TXN_TOKEN", amount: String(amount) },
        merchant: { mid, redirect: false },
        handler: {
          transactionStatus: function(data){
            if (data && (data.STATUS === 'TXN_SUCCESS' || data.status === 'TXN_SUCCESS')) onSuccess?.(data);
            else onFailure?.(data);
          },
          notifyMerchant: function(eventName, data){ console.log("notifyMerchant", eventName, data); }
        }
      };
      await window.Paytm.CheckoutJS.init(config);
      window.Paytm.CheckoutJS.invoke();
    }
    async function grantPlanForUser(user, userData, planKey){
      const now = new Date();
      const currentExp = userData?.planExpiry?.toDate ? userData.planExpiry.toDate() : (userData?.planExpiry ? new Date(userData.planExpiry) : null);
      const base = currentExp && currentExp > now ? currentExp : now;
      const newExpiry = addMonths(base, 1);
      await updateDoc(doc(db,'users', user.uid), { plan: planKey, planExpiry: Timestamp.fromDate(newExpiry) });
      return newExpiry;
    }

    /* ------------------ Uploader (minor mobile spacing tweaks) ------------------ */
    // (unchanged logic; only classes adjusted for mobile spacing)
    // ... ⬅️ keep your UploaderScreen here (unchanged from your last working version) ...

    /* ------------------ Album Viewer (mobile landscape + 2-page + password fix) ------------------ */
    const AlbumViewer = ({ albumId }) => {
      const [album, setAlbum] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState('');
      const [isPlaying, setIsPlaying] = useState(true);
      const [unlocked, setUnlocked] = useState(false);
      const [passInput, setPassInput] = useState('');

      const [needsLandscape, setNeedsLandscape] = useState(false); // ⬅️ NEW
      const containerRef = useRef(null);   // ⬅️ NEW: size-aware
      const flipRef = useRef(null);
      const flip = useRef(null);
      const audioRef = useRef(null);

      // Detect mobile + portrait => request rotate
      useEffect(() => {
        const check = () => {
          const isMobile = window.innerWidth < 768;
          const isPortrait = window.matchMedia('(orientation: portrait)').matches;
          setNeedsLandscape(isMobile && isPortrait);
        };
        check();
        window.addEventListener('resize', check);
        window.addEventListener('orientationchange', check);
        return () => {
          window.removeEventListener('resize', check);
          window.removeEventListener('orientationchange', check);
        };
      }, []);

      useEffect(() => {
        (async () => {
          try {
            const ref = doc(db,'albums', albumId);
            const snap = await getDoc(ref);
            if (!snap.exists()) { setError('Album not found.'); return; }
            const data = snap.data();
            setAlbum({ id: albumId, ...data });
            updateDoc(ref, { views: increment(1) }).catch(()=>{});
            const key = `album-${albumId}-ok`;
            if (!data.passwordProtected || sessionStorage.getItem(key)==='1') setUnlocked(true);
          } catch (e) { console.error(e); setError('Failed to load album.'); }
          finally { setLoading(false); }
        })();
      }, [albumId]);

      // ⬅️ UPDATED: init/re-init PageFlip when album is ready, unlocked, and landscape (or desktop)
      const initFlip = () => {
        if (!flipRef.current) return;
        if (flip.current) { flip.current.destroy(); flip.current = null; }

        // Compute responsive size
        const vw = Math.min(window.innerWidth, document.documentElement.clientWidth || window.innerWidth);
        const vh = Math.min(window.innerHeight, document.documentElement.clientHeight || window.innerHeight);
        // aim for wide double spread; keep aspect
        const width = Math.min(1200, Math.floor(vw * 0.95));
        const height = Math.min(680, Math.floor(vh * 0.70));

        const pageFlip = new St.PageFlip(flipRef.current, {
          width: Math.max(500, width),      // base width
          height: Math.max(360, height),    // base height
          size: "stretch",                  // ⬅️ allow stretch
          maxShadowOpacity: 0.3,
          showCover: true,
          usePortrait: false,               // ⬅️ FORCE double-page even on small screens in landscape
          flippingMode: 'hard',
          autoSize: true                    // ⬅️ keep responsive
        });

        pageFlip.loadFromHTML(flipRef.current.querySelectorAll('.flip-page'));
        flip.current = pageFlip;
      };

      // Re-init when unlocking / rotating / resizing
      useEffect(() => {
        if (!album || !unlocked || needsLandscape) return;
        // Allow DOM to paint before init
        const id = setTimeout(initFlip, 50);
        return () => clearTimeout(id);
      }, [album, unlocked, needsLandscape]);

      useEffect(() => {
        const onResize = () => { if (album && unlocked && !needsLandscape) initFlip(); };
        window.addEventListener('resize', onResize);
        return () => window.removeEventListener('resize', onResize);
      }, [album, unlocked, needsLandscape]);

      const unlock = () => {
        if (passInput === (album?.albumPassword || '')) {
          setUnlocked(true);
          sessionStorage.setItem(`album-${albumId}-ok`, '1');
          // Flipbook will initialize via the effect
        } else { alert('Incorrect password.'); }
      };

      if (loading) return <Loader text="Loading album…" />;
      if (error) return <div className="min-h-screen grid place-items-center p-6 text-red-500">{error}</div>;
      if (!album) return null;

      return (
        <div className="min-h-screen flex flex-col items-center justify-start sm:justify-center p-3 sm:p-4 fade-in">
          {album.musicUrl && (
            <>
              <audio ref={audioRef} src={album.musicUrl} autoPlay loop/>
              <button
                onClick={()=>{ if(isPlaying && audioRef.current) audioRef.current.pause(); else if(audioRef.current) audioRef.current.play(); setIsPlaying(p=>!p); }}
                className="fixed bottom-6 right-6 bg-indigo-600 text-white p-3 rounded-full floating-btn"
                aria-label="Toggle music"
              >
                <MaterialIcon name={isPlaying?'volume_up':'volume_off'}/>
              </button>
            </>
          )}

          <header className="text-center mb-3 sm:mb-6">
            <h1 className="text-2xl sm:text-3xl md:text-4xl font-bold tracking-tight">{album.title}</h1>
            {album.showLabName && album.labName && (
              <p className="text-slate-500 mt-1 text-sm sm:text-base">by <span className="font-semibold">{album.labName}</span></p>
            )}
            <a href={window.location.origin + window.location.pathname}
               className="mt-2 inline-block text-indigo-600 dark:text-indigo-400 font-semibold hover:text-indigo-800 transition-colors text-sm sm:text-base">
              Create your own album →
            </a>
          </header>

          {/* ⬅️ NEW: Landscape prompt on phones */}
          {needsLandscape && (
            <div className="rotate-overlay">
              <div className="rotate-box">
                <div className="mx-auto mb-3 w-16 h-16 rounded-2xl bg-indigo-600 text-white grid place-items-center">
                  <MaterialIcon name="screen_rotation"/>
                </div>
                <h3 className="text-xl font-bold mb-1">Rotate your device</h3>
                <p className="text-slate-500 mb-4">For the best experience, please view this e-album in <strong>landscape</strong> mode.</p>
                <button
                  onClick={()=>{ /* re-check immediately */ window.dispatchEvent(new Event('resize')); }}
                  className="bg-indigo-600 text-white px-4 py-2 rounded-lg"
                >I’ve rotated</button>
              </div>
            </div>
          )}

          {album.passwordProtected && !unlocked ? (
            <div className="w-full max-w-md bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl p-6 shadow-xl mobile-card">
              <h3 className="text-xl font-semibold mb-2">This album is protected</h3>
              <p className="text-sm text-slate-500 mb-4">Enter the password to view.</p>
              <input type="password" value={passInput} onChange={e=>setPassInput(e.target.value)} placeholder="Album password"
                     className="w-full p-3 border rounded-lg bg-transparent"/>
              <button onClick={unlock} className="w-full mt-3 bg-indigo-600 text-white py-3 rounded-lg font-semibold mobile-btn">Unlock</button>
            </div>
          ) : (
            <>
              <div ref={containerRef} className="flipbook-wrap w-full">
                <div className="flipbook-container" ref={flipRef}>
                  <div className="flip-page cover-page" data-density="hard">
                    {album.frontCoverUrl ? <img src={album.frontCoverUrl} alt="Front cover"/> : <h2 className="text-2xl font-bold">{album.title}</h2>}
                  </div>
                  {album.imageUrls.map((url,i)=>(
                    <div key={i} className="flip-page">
                      <img src={url} alt={`Photo ${i+1}`}/>
                    </div>
                  ))}
                  <div className="flip-page cover-page" data-density="hard">
                    {album.backCoverUrl ? <img src={album.backCoverUrl} alt="Back cover"/> : <h2 className="text-xl">The End</h2>}
                  </div>
                </div>
              </div>

              {!needsLandscape && (
                <div className="flex items-center gap-3 sm:gap-4 mt-3 sm:mt-4">
                  <button onClick={()=>flip.current && flip.current.flipPrev()} className="bg-white dark:bg-slate-700 p-3 rounded-full shadow-lg hover:bg-slate-100 dark:hover:bg-slate-600 transition" aria-label="Previous page"><MaterialIcon name="arrow_back"/></button>
                  <span className="text-slate-600 dark:text-slate-300 font-medium text-sm sm:text-base">Turn Page</span>
                  <button onClick={()=>flip.current && flip.current.flipNext()} className="bg-white dark:bg-slate-700 p-3 rounded-full shadow-lg hover:bg-slate-100 dark:hover:bg-slate-600 transition" aria-label="Next page"><MaterialIcon name="arrow_forward"/></button>
                </div>
              )}

              {album.social && (album.social.instagram || album.social.whatsapp || album.social.facebook) && (
                <div className="mt-5 sm:mt-6 flex items-center gap-2 sm:gap-3">
                  {album.social.instagram && <a href={album.social.instagram} target="_blank" rel="noopener" className="px-3 py-2 rounded-lg border hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-2 text-sm sm:text-base"><MaterialIcon name="photo_camera"/> Instagram</a>}
                  {album.social.whatsapp && <a href={album.social.whatsapp} target="_blank" rel="noopener" className="px-3 py-2 rounded-lg border hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-2 text-sm sm:text-base"><MaterialIcon name="whatsapp"/> WhatsApp</a>}
                  {album.social.facebook && <a href={album.social.facebook} target="_blank" rel="noopener" className="px-3 py-2 rounded-lg border hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-2 text-sm sm:text-base"><MaterialIcon name="facebook"/> Facebook</a>}
                </div>
              )}
            </>
          )}
        </div>
      );
    };

    /* ------------------ Dashboard, Edit, Pricing, FAQ, Contact ------------------ */
    // (Use your previously-working versions; no logic changes needed for this task)
    // ... Keep your DashboardScreen, EditAlbumModal, PricingScreen, FaqScreen, ContactScreen and UploaderScreen here ...

    /* ------------------ App & Router ------------------ */
    const App = () => {
      const [theme, setTheme] = useState(localStorage.getItem('theme') || 'light');
      useEffect(()=>{
        const prefers = window.matchMedia('(prefers-color-scheme: dark)');
        const init = localStorage.getItem('theme') || (prefers.matches ? 'dark' : 'light');
        setTheme(init);
        const onChange = (e)=>{ if (!('theme' in localStorage)) setTheme(e.matches?'dark':'light'); };
        prefers.addEventListener('change', onChange);
        return ()=> prefers.removeEventListener('change', onChange);
      }, []);
      useEffect(()=>{ document.documentElement.classList.toggle('dark', theme==='dark'); }, [theme]);
      const toggleTheme = ()=>{ const t = theme==='light'?'dark':'light'; setTheme(t); localStorage.setItem('theme', t); };

      return <MainRouter theme={theme} toggleTheme={toggleTheme}/>;
    };

    const MainRouter = ({ theme, toggleTheme }) => {
      const [authState, setAuthState] = useState({ isLoading:true, user:null, isNewUser:false, userData:null });
      const [loading, setLoading] = useState(false);
      const [view, setView] = useState('dashboard');
      window.__setView = setView;

      const urlParams = new URLSearchParams(window.location.search);
      const albumId = urlParams.get('album');

      useEffect(()=>{
        if (albumId) { setAuthState(s=>({...s, isLoading:false})); return; }
        const unsub = onAuthStateChanged(auth, async (user)=>{
          setAuthState({ isLoading:true, user:null, isNewUser:false, userData:null });
          if (user) {
            await user.reload();
            if (user.emailVerified) {
              const ref = doc(db,'users', user.uid);
              const udoc = await getDoc(ref);
              let data = udoc.exists() ? udoc.data() : null;
              if (data && data.plan && data.plan !== 'free') {
                const exp = data.planExpiry?.toDate ? data.planExpiry.toDate() : (data.planExpiry ? new Date(data.planExpiry) : null);
                if (!exp || exp < new Date()) {
                  await updateDoc(ref, { plan:'free', planExpiry: null }).catch(()=>{});
                  data = { ...data, plan:'free', planExpiry: null };
                }
              }
              setAuthState({ isLoading:false, user, isNewUser:!udoc.exists(), userData: data });
            } else {
              setAuthState({ isLoading:false, user, isNewUser:false, userData:null });
            }
          } else {
            setAuthState({ isLoading:false, user:null, isNewUser:false, userData:null });
          }
        });
        return () => unsub();
      }, []);

      const completeDetails = async (details) => {
        setLoading(true);
        const u = auth.currentUser;
        if (u) {
          const data = { ...details, email:u.email, createdAt: Timestamp.fromDate(new Date()), plan:'free', planExpiry: null };
          await setDoc(doc(db,'users', u.uid), data);
          setAuthState(prev=>({ ...prev, isNewUser:false, userData:data }));
        }
        setLoading(false);
      };
      const onProfileUpdate = (newData) => setAuthState(prev=>({ ...prev, userData:newData }));

      if (albumId) return <AlbumViewer albumId={albumId}/>;
      if (authState.isLoading || loading) return <Loader/>;

      if (!authState.user) return <AuthScreen/>;
      if (!authState.user.emailVerified) return <VerifyEmailScreen user={authState.user}/>;
      if (authState.isNewUser) return <NewUserDetailsForm user={authState.user} onComplete={completeDetails}/>;

      // ⬅️ Insert your working components (UploaderScreen, DashboardScreen, ProfileScreen, PricingScreen, FaqScreen, ContactScreen)
      // For brevity, only route wiring is shown here:
      const renderView = () => {
        switch (view) {
          case 'dashboard': return <DashboardScreen user={authState.user} userData={authState.userData}/>;
          case 'uploader':  return <UploaderScreen  user={authState.user} userData={authState.userData}/>;
          case 'profile':   return <ProfileScreen  user={authState.user} userData={authState.userData} onUpdate={onProfileUpdate}/>;
          case 'pricing':   return <PricingScreen  user={authState.user} userData={authState.userData} onPlanChange={(plan)=>setAuthState(prev=>({...prev, userData:{...prev.userData, plan, planExpiry: prev.userData?.planExpiry || null}}))}/>;
          case 'faq':       return <FaqScreen/>;
          case 'contact':   return <ContactScreen/>;
          default:          return <DashboardScreen user={authState.user} userData={authState.userData}/>;
        }
      };

      return (
        <>
          <TopNav view={view} setView={setView} user={authState.user} theme={theme} toggleTheme={toggleTheme}/>
          <main className="mobile-pad">{renderView()}</main>
        </>
      );
    };

    // ⬅️ NOTE: Keep your existing implementations of
    // UploaderScreen, DashboardScreen, EditAlbumModal, PricingScreen, FaqScreen, ContactScreen, ProfileScreen
    // from your last working code. This file focuses on AlbumViewer + mobile polish.

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
